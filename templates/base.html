<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}semblnyce - clothing from the cracks of the city{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="container">
        <nav>
            <a href="/" class="logo">semblnyce</a>

            <!-- Desktop Navigation -->
            <ul class="nav-links desktop-nav">
                <li><a href="/shop">Shop</a></li>
                <li><a href="/about">About Us</a></li>
                <li><a href="/contact">Contact</a></li>
                <li><a href="/cart" class="cart-link">Cart (<span id="cartCount">0</span>)</a></li>
            </ul>

            <!-- Mobile Hamburger Menu -->
            <div class="mobile-nav">
                <button class="hamburger" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="mobile-menu" id="mobileMenu">
                    <a href="/shop">Shop</a>
                    <a href="/about">About Us</a>
                    <a href="/contact">Contact</a>
                    <a href="/cart" class="cart-link">Cart (<span class="mobile-cart-count">0</span>)</a>
                </div>
            </div>
        </nav>

        {% block content %}{% endblock %}
    </div>

    <!-- Cookie Consent Modal -->
    {% if show_cookie_banner %}
    <div id="cookieModal" class="cookie-modal">
        <div class="cookie-content">
            <h3>Cookie Preferences</h3>
            <p>We use cookies to enhance your experience and track site usage for analytics. This helps us understand our visitors and improve our service.</p>
            <p><strong>Enabling cookies helps us:</strong></p>
            <ul>
                <li>Track unique visitors and returning users</li>
                <li>Understand which pages are most popular</li>
                <li>Improve your shopping experience</li>
                <li>Remember your cart items</li>
            </ul>
            <div class="cookie-buttons">
                <button onclick="acceptCookies()" class="btn">ACCEPT COOKIES</button>
                <button onclick="denyCookies()" class="btn btn-secondary">CONTINUE WITHOUT COOKIES</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Google Sign-In -->
    <div id="g_id_onload"
         data-client_id="YOUR_GOOGLE_CLIENT_ID"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>

    <script>
    // Update cart count on page load
    function updateCartCount() {
        fetch('/cart')
            .then(() => {
                const cartItems = {{ session.get('cart', [])|tojson }};
                const cartCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById('cartCount').textContent = cartCount;
                const mobileCartCount = document.querySelector('.mobile-cart-count');
                if (mobileCartCount) {
                    mobileCartCount.textContent = cartCount;
                }
            })
            .catch(() => {});
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        const hamburger = document.querySelector('.hamburger');
        mobileMenu.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
        const mobileNav = document.querySelector('.mobile-nav');
        const mobileMenu = document.getElementById('mobileMenu');
        const hamburger = document.querySelector('.hamburger');

        if (mobileMenu && !mobileNav.contains(event.target)) {
            mobileMenu.classList.remove('active');
            hamburger.classList.remove('active');
        }
    });

    // Cookie functions
    function acceptCookies() {
        fetch('/accept_cookies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('cookieModal').style.display = 'none';
                location.reload();
            }
        });
    }

    function denyCookies() {
        fetch('/deny_cookies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('cookieModal').style.display = 'none';
            }
        });
    }

    // Google Sign-In callback
    function handleCredentialResponse(response) {
        const responsePayload = decodeJwtResponse(response.credential);

        fetch('/google_signin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: responsePayload.email,
                name: responsePayload.name
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Google sign-in successful');
            }
        });
    }

    function decodeJwtResponse(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    // Initialize cart count on page load
    updateCartCount();
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>