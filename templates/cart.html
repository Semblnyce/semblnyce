{% extends "base.html" %}
{% block title %}Shopping Cart - semblnyce{% endblock %}
{% block content %}
<h1 style="text-align: center; margin-bottom: 40px;">YOUR CART</h1>

<div style="max-width: 800px; margin: 0 auto;">
    {% if cart_items %}
        <div class="cart-items">
            {% for item in cart_items %}
            <div class="cart-item">
                <a href="/product/{{ item.id }}" class="cart-item-image">
                    <div>{{ item.image }}</div>
                </a>

                <div class="cart-item-details">
                    <h3><a href="/product/{{ item.id }}" style="color: #fff; text-decoration: none;">{{ item.name }}</a></h3>
                    <p>Size: {{ item.size }}</p>
                    <p>${{ item.price }} each</p>
                </div>

                <div class="cart-item-controls">
                    <button onclick="updateCart('{{ item.id }}', '{{ item.size }}', 'decrease')" class="btn btn-secondary" style="padding: 5px 10px;">âˆ’</button>
                    <span class="cart-item-quantity">{{ item.quantity }}</span>
                    <button onclick="updateCart('{{ item.id }}', '{{ item.size }}', 'increase')" class="btn btn-secondary" style="padding: 5px 10px;">+</button>
                </div>

                <div class="cart-item-total">
                    ${{ "%.2f"|format(item.price * item.quantity) }}
                </div>

                <button onclick="updateCart('{{ item.id }}', '{{ item.size }}', 'remove')" class="btn btn-secondary" style="padding: 5px 15px;">REMOVE</button>
            </div>
            {% endfor %}
        </div>

        <div class="cart-summary">
            <div class="cart-total">
                <h2>TOTAL: $<span id="cartTotal">{{ "%.2f"|format(total) }}</span></h2>
            </div>
            <div class="cart-actions">
                <a href="/shop" class="btn btn-secondary" style="margin-right: 10px;">CONTINUE SHOPPING</a>
                <button onclick="openCheckoutModal()" class="btn btn-large">CHECKOUT</button>
            </div>
        </div>
    {% else %}
        <div class="content-box" style="text-align: center; padding: 60px 20px;">
            <h2 style="margin-bottom: 20px;">YOUR CART IS EMPTY</h2>
            <p style="margin-bottom: 30px;">Add some street gear to your collection</p>
            <a href="/shop" class="btn">START SHOPPING</a>
        </div>
    {% endif %}
</div>

<!-- Checkout Modal -->
<div id="checkoutModal" style="display: none;" class="payment-modal">
    <div class="payment-form">
        <h2>COMPLETE YOUR ORDER</h2>
        <div id="order-summary" style="margin-bottom: 30px;">
            <h3>Order Summary:</h3>
            <div id="checkout-items">
                {% for item in cart_items %}
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                    <div>
                        <strong>{{ item.name }}</strong><br>
                        <small>Size: {{ item.size }} | Qty: {{ item.quantity }}</small>
                    </div>
                    <div>${{ "%.2f"|format(item.price * item.quantity) }}</div>
                </div>
                {% endfor %}
            </div>
            <div style="font-size: 1.2rem; margin-top: 15px; padding-top: 15px; border-top: 2px solid #fff;">
                <strong>Total: ${{ "%.2f"|format(total) }}</strong>
            </div>
        </div>

        <form id="checkout-form">
            <input type="text" id="customerName" placeholder="YOUR NAME" required>
            <input type="email" id="customerEmail" placeholder="YOUR EMAIL" required>
            <input type="text" id="shippingAddress" placeholder="SHIPPING ADDRESS" required>
            <div id="card-element"></div>v>
            <div id="card-errors" style="color: red; margin-bottom: 20px;"></div>
            <button type="submit" class="btn btn-large" style="width: 100%;">
                <span id="button-text">COMPLETE PURCHASE</span>
                <span class="spinner" style="display: none;"></span>
            </button>
        </form>

        <button onclick="closeCheckoutModal()" class="btn btn-secondary" style="margin-top: 10px; width: 100%;">CANCEL</button>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_public_key or "pk_test_..." }}');
const elements = stripe.elements();
const cardElement = elements.create('card', {
    style: {
        base: {
            color: '#ffffff',
            fontFamily: '"Inter", sans-serif',
            fontSize: '16px',
            '::placeholder': {
                color: '#666666'
            }
        }
    }
});

function updateCart(productId, size, action) {
    fetch('/update_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: productId,
            size: size,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Reload to update cart display
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating cart');
    });
}

function openCheckoutModal() {
    const cartItems = {{ cart_items|tojson }};
    if (cartItems.length === 0) {
        alert('Your cart is empty');
        return;
    }

    document.getElementById('checkoutModal').style.display = 'flex';
    cardElement.mount('#card-element');
}

function closeCheckoutModal() {
    document.getElementById('checkoutModal').style.display = 'none';
    cardElement.unmount();
}

// Checkout form submission
document.getElementById('checkout-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitButton = document.querySelector('#checkout-form button[type="submit"]');
    submitButton.disabled = true;
    document.getElementById('button-text').style.display = 'none';
    document.querySelector('#checkout-form .spinner').style.display = 'inline-block';

    try {
        // Create payment intent
        const response = await fetch('/create-payment-intent', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: 'purchase'
            })
        });

        if (!response.ok) {
            throw new Error('Failed to create payment intent');
        }

        const {clientSecret} = await response.json();

        // Confirm payment
        const {error} = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    address: {
                        line1: document.getElementById('shippingAddress').value
                    }
                }
            }
        });

        if (error) {
            document.getElementById('card-errors').textContent = error.message;
        } else {
            // Payment successful
            const successResponse = await fetch('/payment-success', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type: 'purchase',
                    customer_name: document.getElementById('customerName').value,
                    customer_email: document.getElementById('customerEmail').value,
                    shipping_address: document.getElementById('shippingAddress').value
                })
            });

            if (successResponse.ok) {
                alert('Thank you for your purchase! You\'ll receive a confirmation email shortly.');
                closeCheckoutModal();
                window.location.href = '/shop';
            } else {
                throw new Error('Failed to process payment success');
            }
        }
    } catch (error) {
        console.error('Checkout error:', error);
        document.getElementById('card-errors').textContent = 'An error occurred. Please try again.';
    } finally {
        submitButton.disabled = false;
        document.getElementById('button-text').style.display = 'inline';
        document.querySelector('#checkout-form .spinner').style.display = 'none';
    }
});
</script>
{% endblock %}