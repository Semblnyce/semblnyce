
{% extends "base.html" %}

{% block title %}Checkout - semblnyce{% endblock %}

{% block content %}
<div class="checkout-container">
    <h1>CHECKOUT</h1>
    
    <div class="checkout-sections">
        <div class="shipping-section">
            <h2>SHIPPING INFORMATION</h2>
            <form id="shipping-form">
                <div class="form-group">
                    <input type="text" id="fullName" placeholder="FULL NAME" required>
                </div>
                <div class="form-group">
                    <input type="email" id="email" placeholder="EMAIL" required>
                </div>
                <div class="form-group">
                    <input type="tel" id="phone" placeholder="PHONE NUMBER">
                </div>
                <div class="form-group">
                    <input type="text" id="address1" placeholder="ADDRESS LINE 1" required>
                </div>
                <div class="form-group">
                    <input type="text" id="address2" placeholder="ADDRESS LINE 2 (OPTIONAL)">
                </div>
                <div class="form-row">
                    <input type="text" id="city" placeholder="CITY" required>
                    <input type="text" id="state" placeholder="STATE" required>
                    <input type="text" id="zip" placeholder="ZIP CODE" required>
                </div>
                <div class="form-group">
                    <select id="country" required>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="GB">United Kingdom</option>
                        <!-- Add more countries as needed -->
                    </select>
                </div>
            </form>
        </div>

        <div class="payment-section">
            <h2>PAYMENT</h2>
            <div id="card-element"></div>
            <div id="card-errors" role="alert"></div>
            
            <button id="submit-payment" class="btn">
                <span id="button-text">COMPLETE ORDER ($<span id="total-amount">0</span>)</span>
                <span class="spinner" style="display: none;"></span>
            </button>
        </div>
    </div>

    <div class="order-summary">
        <h2>ORDER SUMMARY</h2>
        <div id="order-items">
            {% for item in cart_items %}
            <div class="order-item">
                <span>{{ item.name }} ({{ item.size }}) x{{ item.quantity }}</span>
                <span>${{ "%.2f"|format(item.price * item.quantity) }}</span>
            </div>
            {% endfor %}
        </div>
        <div class="order-total">
            <strong>Total: ${{ "%.2f"|format(total) }}</strong>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();
const cardElement = elements.create('card', {
    style: {
        base: {
            color: '#ffffff',
            fontFamily: '"Inter", sans-serif',
            fontSize: '16px',
            '::placeholder': {
                color: '#666666'
            }
        }
    }
});

cardElement.mount('#card-element');

// Handle form submission
document.getElementById('submit-payment').addEventListener('click', async (event) => {
    event.preventDefault();
    
    const submitButton = document.getElementById('submit-payment');
    const buttonText = document.getElementById('button-text');
    const spinner = document.querySelector('.spinner');
    
    submitButton.disabled = true;
    buttonText.style.display = 'none';
    spinner.style.display = 'inline-block';

    try {
        // Create payment intent
        const response = await fetch('/create-payment-intent', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        const {clientSecret} = await response.json();

        // Confirm payment
        const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: {
                        line1: document.getElementById('address1').value,
                        line2: document.getElementById('address2').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        postal_code: document.getElementById('zip').value,
                        country: document.getElementById('country').value
                    }
                }
            }
        });

        if (error) {
            document.getElementById('card-errors').textContent = error.message;
            submitButton.disabled = false;
            buttonText.style.display = 'inline';
            spinner.style.display = 'none';
        } else {
            // Payment successful, notify backend
            await fetch('/payment-success', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    payment_intent_id: paymentIntent.id,
                    name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address1: document.getElementById('address1').value,
                    address2: document.getElementById('address2').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value,
                    country: document.getElementById('country').value
                })
            });
            
            window.location.href = '/checkout-success';
        }
    } catch (error) {
        document.getElementById('card-errors').textContent = 'An error occurred. Please try again.';
        submitButton.disabled = false;
        buttonText.style.display = 'inline';
        spinner.style.display = 'none';
    }
});

// Handle payment cancellation (when user navigates away)
window.addEventListener('beforeunload', async () => {
    // Notify backend of cancellation if payment was in progress
    const pendingOrder = sessionStorage.getItem('pendingPayment');
    if (pendingOrder) {
        await fetch('/payment-cancelled', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                payment_intent_id: pendingOrder
            })
        });
        sessionStorage.removeItem('pendingPayment');
    }
});

// Set total amount
document.getElementById('total-amount').textContent = '{{ "%.2f"|format(total) }}';
</script>

<style>
.checkout-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
}

.checkout-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    margin: 40px 0;
}

.shipping-section, .payment-section {
    background: #111;
    border: 2px solid #fff;
    padding: 30px;
}

.form-group {
    margin-bottom: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
}

.form-group input, .form-group select, .form-row input {
    width: 100%;
    padding: 15px;
    background: #000;
    color: #fff;
    border: 1px solid #fff;
    font-family: 'Inter', sans-serif;
    font-size: 16px;
}

.order-summary {
    background: #111;
    border: 2px solid #fff;
    padding: 30px;
    margin-top: 20px;
}

.order-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.order-total {
    border-top: 1px solid #fff;
    padding-top: 10px;
    margin-top: 10px;
    font-size: 1.2rem;
}

#card-element {
    padding: 15px;
    background: #000;
    border: 1px solid #fff;
    margin-bottom: 20px;
}

#card-errors {
    color: #ff6b6b;
    margin-top: 10px;
}

@media (max-width: 768px) {
    .checkout-sections {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
